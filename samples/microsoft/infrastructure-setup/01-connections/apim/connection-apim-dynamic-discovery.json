{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.37.4.10188",
      "templateHash": "15998365188909223298"
    }
  },
  "parameters": {
    "projectResourceId": {
      "type": "string",
      "defaultValue": "/subscriptions/12345678-1234-1234-1234-123456789abc/resourceGroups/rg-sample/providers/Microsoft.CognitiveServices/accounts/sample-foundry-account/projects/sample-project"
    },
    "apimResourceId": {
      "type": "string",
      "defaultValue": "/subscriptions/87654321-4321-4321-4321-cba987654321/resourceGroups/rg-sample-apim/providers/Microsoft.ApiManagement/service/sample-apim-service"
    },
    "apiName": {
      "type": "string",
      "defaultValue": "foundry"
    },
    "apimSubscriptionName": {
      "type": "string",
      "defaultValue": "master"
    },
    "connectionName": {
      "type": "string",
      "defaultValue": ""
    },
    "authType": {
      "type": "string",
      "defaultValue": "ApiKey",
      "allowedValues": [
        "ApiKey",
        "AAD"
      ]
    },
    "isSharedToAll": {
      "type": "bool",
      "defaultValue": false
    },
    "deploymentInPath": {
      "type": "string",
      "defaultValue": "false",
      "allowedValues": [
        "true",
        "false"
      ]
    },
    "listModelsEndpoint": {
      "type": "string",
      "defaultValue": "v1/models"
    },
    "getModelEndpoint": {
      "type": "string",
      "defaultValue": "v1/models/{deploymentName}"
    },
    "deploymentProvider": {
      "type": "string",
      "defaultValue": "OpenAI"
    }
  },
  "variables": {
    "apimServiceName": "[split(parameters('apimResourceId'), '/')[8]]",
    "generatedConnectionName": "[format('apim-{0}-{1}-v4', variables('apimServiceName'), parameters('apiName'))]",
    "finalConnectionName": "[if(not(equals(parameters('connectionName'), '')), parameters('connectionName'), variables('generatedConnectionName'))]",
    "modelDiscoveryObject": {
      "listModelsEndpoint": "[parameters('listModelsEndpoint')]",
      "getModelEndpoint": "[parameters('getModelEndpoint')]",
      "deploymentProvider": "[parameters('deploymentProvider')]"
    },
    "example3Metadata": {
      "deploymentInPath": "[parameters('deploymentInPath')]",
      "modelDiscovery": "[string(variables('modelDiscoveryObject'))]"
    }
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "apim-connection-example4",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "projectResourceId": {
            "value": "[parameters('projectResourceId')]"
          },
          "connectionName": {
            "value": "[variables('finalConnectionName')]"
          },
          "apimResourceId": {
            "value": "[parameters('apimResourceId')]"
          },
          "apiName": {
            "value": "[parameters('apiName')]"
          },
          "apimSubscriptionName": {
            "value": "[parameters('apimSubscriptionName')]"
          },
          "authType": {
            "value": "[parameters('authType')]"
          },
          "isSharedToAll": {
            "value": "[parameters('isSharedToAll')]"
          },
          "metadata": {
            "value": "[variables('example3Metadata')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "5161752358692660897"
            }
          },
          "parameters": {
            "projectResourceId": {
              "type": "string"
            },
            "connectionName": {
              "type": "string"
            },
            "apimResourceId": {
              "type": "string"
            },
            "apiName": {
              "type": "string"
            },
            "apimSubscriptionName": {
              "type": "string",
              "defaultValue": "master"
            },
            "authType": {
              "type": "string",
              "defaultValue": "ApiKey"
            },
            "isSharedToAll": {
              "type": "bool",
              "defaultValue": false
            },
            "metadata": {
              "type": "object"
            }
          },
          "variables": {
            "aiFoundryName": "[split(parameters('projectResourceId'), '/')[8]]",
            "projectName": "[split(parameters('projectResourceId'), '/')[10]]",
            "apimSubscriptionId": "[split(parameters('apimResourceId'), '/')[2]]",
            "apimResourceGroupName": "[split(parameters('apimResourceId'), '/')[4]]",
            "apimServiceName": "[split(parameters('apimResourceId'), '/')[8]]"
          },
          "resources": [
            {
              "condition": "[equals(parameters('authType'), 'ApiKey')]",
              "type": "Microsoft.CognitiveServices/accounts/projects/connections",
              "apiVersion": "2025-04-01-preview",
              "name": "[format('{0}/{1}/{2}', variables('aiFoundryName'), variables('projectName'), parameters('connectionName'))]",
              "properties": {
                "category": "ApiManagement",
                "target": "[format('{0}/{1}', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('apimSubscriptionId'), variables('apimResourceGroupName')), 'Microsoft.ApiManagement/service', variables('apimServiceName')), '2021-08-01').gatewayUrl, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('apimSubscriptionId'), variables('apimResourceGroupName')), 'Microsoft.ApiManagement/service/apis', variables('apimServiceName'), parameters('apiName')), '2021-08-01').path)]",
                "authType": "ApiKey",
                "isSharedToAll": "[parameters('isSharedToAll')]",
                "credentials": {
                  "key": "[listSecrets(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('apimSubscriptionId'), variables('apimResourceGroupName')), 'Microsoft.ApiManagement/service/subscriptions', variables('apimServiceName'), parameters('apimSubscriptionName')), '2021-08-01').primaryKey]"
                },
                "metadata": "[parameters('metadata')]"
              }
            }
          ],
          "outputs": {
            "connectionName": {
              "type": "string",
              "value": "[if(equals(parameters('authType'), 'ApiKey'), parameters('connectionName'), '')]"
            },
            "connectionId": {
              "type": "string",
              "value": "[if(equals(parameters('authType'), 'ApiKey'), resourceId('Microsoft.CognitiveServices/accounts/projects/connections', variables('aiFoundryName'), variables('projectName'), parameters('connectionName')), '')]"
            },
            "targetUrl": {
              "type": "string",
              "value": "[format('{0}/{1}', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('apimSubscriptionId'), variables('apimResourceGroupName')), 'Microsoft.ApiManagement/service', variables('apimServiceName')), '2021-08-01').gatewayUrl, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('apimSubscriptionId'), variables('apimResourceGroupName')), 'Microsoft.ApiManagement/service/apis', variables('apimServiceName'), parameters('apiName')), '2021-08-01').path)]"
            },
            "authType": {
              "type": "string",
              "value": "[parameters('authType')]"
            },
            "metadata": {
              "type": "object",
              "value": "[parameters('metadata')]"
            }
          }
        }
      }
    }
  ],
  "outputs": {
    "connectionName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'apim-connection-example4'), '2022-09-01').outputs.connectionName.value]"
    },
    "connectionId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'apim-connection-example4'), '2022-09-01').outputs.connectionId.value]"
    },
    "targetUrl": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'apim-connection-example4'), '2022-09-01').outputs.targetUrl.value]"
    },
    "authType": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'apim-connection-example4'), '2022-09-01').outputs.authType.value]"
    },
    "metadata": {
      "type": "object",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'apim-connection-example4'), '2022-09-01').outputs.metadata.value]"
    }
  }
}